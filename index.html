<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Card√°pio da Cantina - Col√©gio Imperatriz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-slate-100 p-4 font-sans">

<!-- ====== CONTAINER PRINCIPAL ====== -->
<div class="max-w-6xl mx-auto">
  <!-- ====== CABE√áALHO ====== -->
  <header class="flex flex-wrap items-center justify-between mb-4 gap-2">
    <div class="flex items-center gap-3">
      <img src="https://i.ibb.co/KxSrH0Nj/logo.png" alt="Logo" class="h-12" />
      <div>
        <h1 id="titulo" class="text-2xl font-semibold text-green-600">Card√°pio da Cantina</h1>
        <p class="text-sm text-slate-500">
          Cadastro de lanches (manh√£/tarde) - Col√©gio Imperatriz üçΩÔ∏èü•óüçñüçäüçÆ
        </p>
      </div>
    </div>
    <div class="space-x-2">
      <button onclick="changeMonth(-1)" class="btn">‚óÄ</button>
      <button onclick="goToday()" class="btn">Hoje</button>
      <button onclick="changeMonth(1)" class="btn">‚ñ∂</button>
      <button id="exportBtn" onclick="generateImage()" class="btn-primary">Exportar PNG</button>
      <button id="exportPdfBtn" onclick="generatePDF()" class="btn-primary bg-red-600">Exportar PDF</button>
    </div>
  </header>

  <!-- ====== CALEND√ÅRIO ====== -->
  <div id="calendar" class="p-4 bg-white rounded-2xl shadow-md">
    <div class="grid grid-cols-6 gap-2 text-center mb-2 font-medium text-base">
      <div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>S√°b</div>
    </div>
    <div id="calendar-grid" class="grid grid-cols-6 gap-2"></div>
  </div>
</div>

<!-- ====== MODAL DE EDI√á√ÉO ====== -->
<div id="modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-xl shadow-xl w-96 space-y-4">
    <h2 class="text-lg font-semibold text-green-600">Editar Card√°pio</h2>
    <p id="modal-date" class="text-sm text-slate-500"></p>
    <textarea id="manha" placeholder="Lanche da manh√£..." class="w-full border rounded p-2 h-20"></textarea>
    <textarea id="tarde" placeholder="Lanche da tarde..." class="w-full border rounded p-2 h-20"></textarea>
    <div class="flex justify-between">
      <button id="deleteBtn" class="px-3 py-1 bg-red-500 text-white rounded">Excluir</button>
      <div class="space-x-2">
        <button onclick="closeModal()" class="btn">Cancelar</button>
        <button onclick="saveDay()" class="btn-primary">Salvar</button>
      </div>
    </div>
  </div>
</div>

<style>
  .btn { padding: 0.5rem 0.75rem; border-radius: .5rem; border: 1px solid #e2e8f0; background: white }
  .btn-primary { padding: 0.5rem 0.75rem; border-radius: .5rem; background: #16a34a; color: white; border: none }
</style>

<script>
const SUPABASE_URL = "https://lfhgyyhzvhmdphgbvblc.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxmaGd5eWh6dmhtZHBoZ2J2YmxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MzEzOTYsImV4cCI6MjA3NTUwNzM5Nn0.ZAcoIbeOQFIo01qW_rcKIkJKvneqgeN6rpPSCFvTe1Y";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const calendarGrid = document.getElementById("calendar-grid");
const titulo = document.getElementById("titulo");
let viewDate = new Date();
viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
let menuData = {};
let currentISO = "";

function formatISO(y, m, d) {
  return `${y}-${String(m + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
}
function escapeHtml(str) {
  return str ? str.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c])) : "";
}

async function loadData() {
  const { data, error } = await supabaseClient.from("cardapio_cantina").select("data_iso, manha, tarde");
  if (error) return console.error(error);
  menuData = {};
  data.forEach(r => menuData[r.data_iso] = { manha: r.manha, tarde: r.tarde });
  renderCalendar();
}

function renderCalendar() {
  const year = viewDate.getFullYear();
  const month = viewDate.getMonth();
  titulo.textContent = `Card√°pio da Cantina ‚Äî ${viewDate.toLocaleString("pt-BR",{month:"long"})} ${year}`;
  calendarGrid.innerHTML = "";

  const daysInMonth = new Date(year, month + 1, 0).getDate();
  let filledCols = 0;
  const createEmptyCell = () => {
    const div = document.createElement("div");
    div.className = "p-2 min-h-[100px]";
    return div;
  };

  for (let d = 1; d <= daysInMonth; d++) {
    const dt = new Date(year, month, d);
    const weekday = dt.getDay(); 
    if (weekday === 0) continue;
    const col = weekday - 1;
    if (filledCols > col) while (filledCols < 6) calendarGrid.appendChild(createEmptyCell()), filledCols++;
    if (filledCols >= 6) filledCols = 0;
    while (filledCols < col) calendarGrid.appendChild(createEmptyCell()), filledCols++;

    const iso = formatISO(year, month, d);
    const entry = menuData[iso] || {};
    const div = document.createElement("div");
    div.className = "p-3 border rounded bg-white min-h-[110px] text-base shadow-sm hover:shadow-md transition";
    div.innerHTML = `
      <div class="flex justify-between items-start">
        <div class="font-semibold">${d}</div>
        <div class="text-xs text-slate-400">${dt.toLocaleDateString()}</div>
      </div>
      <div class="text-left whitespace-pre-wrap break-words mt-1">
        ${entry.manha ? `<div><b>Manh√£:</b> ${escapeHtml(entry.manha)}</div>` : `<div class='text-slate-400'>Clique para editar</div>`}
        ${entry.tarde ? `<div><b>Tarde:</b> ${escapeHtml(entry.tarde)}</div>` : ``}
      </div>
      <div class="text-right mt-2">
        <button onclick="openModalForDay('${iso}')" class="text-xs underline text-green-700">Editar</button>
      </div>`;
    calendarGrid.appendChild(div);
    filledCols++;
  }
  while (filledCols > 0 && filledCols < 6) calendarGrid.appendChild(createEmptyCell()), filledCols++;
}

function openModalForDay(iso) {
  currentISO = iso;
  const entry = menuData[iso] || {};
  document.getElementById("manha").value = entry.manha || "";
  document.getElementById("tarde").value = entry.tarde || "";
  document.getElementById("modal-date").textContent = new Date(iso).toLocaleDateString("pt-BR",{weekday:"long",day:"numeric",month:"long"});
  document.getElementById("modal").classList.remove("hidden");
}
function closeModal() {
  document.getElementById("modal").classList.add("hidden");
}
async function saveDay() {
  const manha = document.getElementById("manha").value.trim();
  const tarde = document.getElementById("tarde").value.trim();
  await supabaseClient.from("cardapio_cantina").upsert({ data_iso: currentISO, manha, tarde });
  closeModal(); loadData();
}
document.getElementById("deleteBtn").onclick = async () => {
  if (!confirm("Excluir este dia?")) return;
  await supabaseClient.from("cardapio_cantina").delete().eq("data_iso", currentISO);
  closeModal(); loadData();
};
function changeMonth(delta){ viewDate=new Date(viewDate.getFullYear(),viewDate.getMonth()+delta,1); renderCalendar();}
function goToday(){ const d=new Date(); viewDate=new Date(d.getFullYear(),d.getMonth(),1); renderCalendar();}

/* ====== EXPORTA√á√ÉO AJUSTADA ====== */
async function prepareExportWrapper(){
  const calendar = document.getElementById("calendar").cloneNode(true);
  calendar.querySelectorAll("button").forEach(b => b.remove());

  const style = document.createElement("style");
  style.textContent = `
    * {
      font-size: 18px !important;
      line-height: 1.3 !important;
    }
    #calendar-grid {
      gap: 2px !important;
    }
    #calendar-grid > div {
      padding: 4px 6px !important;
      min-height: 85px !important;
    }
    #calendar {
      padding: 8px !important;
    }
    h2 {
      font-size: 1.8rem !important;
    }
    header, .text-slate-500 {
      display: none !important;
    }
  `;
  calendar.prepend(style);

  const wrap = document.createElement("div");
  wrap.style.position = "absolute";
  wrap.style.left = "-9999px";
  wrap.style.background = "white";
  wrap.style.padding = "20px"; 
  wrap.style.borderRadius = "12px";
  wrap.style.width = "1800px"; 

  const header = document.createElement("div");
  header.className = "flex items-center gap-3 mb-3";
  header.innerHTML = `<img src='https://i.ibb.co/KxSrH0Nj/logo.png' class='h-12'>
    <div>
      <h2 class='text-green-600 text-2xl font-bold'>Card√°pio da Cantina ‚Äî ${viewDate.toLocaleString("pt-BR",{month:"long"})}/${viewDate.getFullYear()}</h2>
      <div class='text-lg'>üçΩÔ∏èü•óüçñüçäüçÆ</div>
    </div>`;
  
  wrap.appendChild(header);
  wrap.appendChild(calendar);
  document.body.appendChild(wrap);
  await new Promise(r => setTimeout(r, 150));
  return {wrap};
}

async function generateImage(){
  const {wrap} = await prepareExportWrapper();
  const canvas = await html2canvas(wrap,{scale:3,backgroundColor:"#fff",useCORS:true});
  const link = document.createElement("a");
  link.href = canvas.toDataURL("image/png");
  link.download = `cantina-${viewDate.getFullYear()}-${String(viewDate.getMonth()+1).padStart(2,"0")}.png`;
  link.click();
  wrap.remove();
}

async function generatePDF(){
  const {wrap} = await prepareExportWrapper();
  const canvas = await html2canvas(wrap,{scale:3,backgroundColor:"#fff",useCORS:true});
  const img = canvas.toDataURL("image/png");
  const pdf = new window.jspdf.jsPDF("landscape","mm","a4");
  const w = pdf.internal.pageSize.getWidth(), h = pdf.internal.pageSize.getHeight();
  const imgProps = pdf.getImageProperties(img);
  const ratio = Math.min(w / imgProps.width, h / imgProps.height);
  const newW = imgProps.width * ratio;
  const newH = imgProps.height * ratio;
  pdf.addImage(img,"PNG",(w-newW)/2,(h-newH)/2,newW,newH);
  pdf.save(`cantina-${viewDate.getFullYear()}-${String(viewDate.getMonth()+1).padStart(2,"0")}.pdf`);
  wrap.remove();
}

loadData();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Card√°pio da Cantina - Col√©gio Imperatriz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-slate-100 p-4">

<div class="max-w-6xl mx-auto">
  <header class="flex flex-wrap items-center justify-between mb-4 gap-2">
    <div>
      <h1 id="titulo" class="text-2xl font-semibold text-green-600">Card√°pio da Cantina</h1>
      <p class="text-sm text-slate-500">Cadastro de lanches (manh√£/tarde) - Col√©gio Imperatriz. Exporta PNG e PDF responsivo. (v2.8)</p>
    </div>
    <div class="space-x-2">
      <button onclick="changeMonth(-1)" class="btn">‚óÄ</button>
      <button onclick="goToday()" class="btn">Hoje</button>
      <button onclick="changeMonth(1)" class="btn">‚ñ∂</button>
      <button id="exportBtn" onclick="generateImage()" class="btn-primary">Exportar PNG</button>
      <button id="exportPdfBtn" onclick="generatePDF()" class="btn-primary bg-red-600">Exportar PDF</button>
    </div>
  </header>

  <div id="calendar" class="p-4 bg-white rounded-2xl shadow-md">
    <div class="grid grid-cols-6 gap-2 text-center mb-2 font-medium">
      <div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>S√°b</div>
    </div>
    <div id="calendar-grid" class="grid grid-cols-6 gap-2"></div>
  </div>
</div>

<style>
  .btn { padding: 0.5rem 0.75rem; border-radius: .5rem; border: 1px solid #e2e8f0; background: white }
  .btn-primary { padding: 0.5rem 0.75rem; border-radius: .5rem; background: #16a34a; color: white; border: none }
</style>

<script>
const SUPABASE_URL = "https://lfhgyyhzvhmdphgbvblc.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxmaGd5eWh6dmhtZHBoZ2J2YmxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MzEzOTYsImV4cCI6MjA3NTUwNzM5Nn0.ZAcoIbeOQFIo01qW_rcKIkJKvneqgeN6rpPSCFvTe1Y";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const calendarGrid = document.getElementById("calendar-grid");
const titulo = document.getElementById("titulo");

let viewDate = new Date();
viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1);
let menuData = {};

function formatISO(y, m, d) {
  return `${y}-${String(m + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
}

async function loadData() {
  try {
    const { data, error } = await supabaseClient
      .from("cardapio_cantina")
      .select("data_iso, manha, tarde");
    if (error) throw error;
    menuData = {};
    data.forEach(row => {
      const iso = typeof row.data_iso === "string"
        ? row.data_iso
        : new Date(row.data_iso).toISOString().slice(0, 10);
      menuData[iso] = { manha: row.manha, tarde: row.tarde };
    });
    renderCalendar();
  } catch (err) {
    console.error("Erro ao carregar dados:", err);
  }
}

function renderCalendar() {
  const year = viewDate.getFullYear();
  const month = viewDate.getMonth();
  titulo.textContent = `Card√°pio da Cantina ‚Äî ${viewDate.toLocaleString("pt-BR", { month: "long" })} ${year}`;
  calendarGrid.innerHTML = "";

  const firstDay = new Date(year, month, 1);
  let startWeekday = firstDay.getDay(); // 0=Dom, 1=Seg, ..., 6=Sab

  // Ajustar para que Segunda seja 0 e Domingo fique fora
  startWeekday = (startWeekday + 6) % 7;

  const daysInMonth = new Date(year, month + 1, 0).getDate();

  // Cria espa√ßos vazios at√© o primeiro dia real
  for (let i = 0; i < startWeekday; i++) {
    const empty = document.createElement("div");
    empty.className = "p-2 min-h-[100px]";
    calendarGrid.appendChild(empty);
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const iso = formatISO(year, month, d);
    const entry = menuData[iso] || {};
    const div = document.createElement("div");
    div.className = "p-2 border rounded bg-white min-h-[100px] text-sm hover:bg-green-50 transition";
    div.innerHTML = `
      <div class="font-semibold">${d}</div>
      <div class="mt-1">
        ${entry.manha ? `<b>Manh√£:</b> ${entry.manha}` : "<span class='text-slate-400'>Clique para editar</span>"}
      </div>
      ${entry.tarde ? `<div><b>Tarde:</b> ${entry.tarde}</div>` : ""}
    `;
    calendarGrid.appendChild(div);
  }
}

function changeMonth(delta) {
  viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth() + delta, 1);
  renderCalendar();
}
function goToday() {
  const d = new Date();
  viewDate = new Date(d.getFullYear(), d.getMonth(), 1);
  renderCalendar();
}

// ====== CORRE√á√ÉO AQUI ======
async function prepareExportWrapper() {
  const calendar = document.getElementById("calendar");
  const clone = calendar.cloneNode(true);
  clone.querySelectorAll("button").forEach(el => el.remove());

  const wrapper = document.createElement("div");
  wrapper.style.position = "absolute";
  wrapper.style.left = "-9999px"; // <-- fora da tela, mas renderiza
  wrapper.style.top = "0";
  wrapper.style.background = "white";
  wrapper.style.padding = "40px";
  wrapper.style.border = "4px solid #16a34a";
  wrapper.style.borderRadius = "20px";
  wrapper.style.fontFamily = "Arial, sans-serif";

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.alignItems = "center";
  header.style.gap = "20px";
  header.style.marginBottom = "20px";

  const logo = document.createElement("img");
  logo.src = "https://i.ibb.co/KxSrH0Nj/logo.png";
  logo.crossOrigin = "anonymous";
  logo.style.maxHeight = "70px";
  await new Promise(r => { logo.onload = r; logo.onerror = r; });

  const titleBlock = document.createElement("div");
  const monthName = viewDate.toLocaleString("pt-BR", { month: "long" });
  const year = viewDate.getFullYear();
  const title = document.createElement("h2");
  title.textContent = `Card√°pio da Cantina ‚Äî ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}/${year}`;
  title.style.color = "#16a34a";
  title.style.fontSize = "22px";
  title.style.fontWeight = "700";
  const icons = document.createElement("div");
  icons.innerHTML = "üçΩÔ∏è ü•ó üçñ üçä üçÆ";
  titleBlock.appendChild(title);
  titleBlock.appendChild(icons);

  header.appendChild(logo);
  header.appendChild(titleBlock);
  wrapper.appendChild(header);
  wrapper.appendChild(clone);
  document.body.appendChild(wrapper);

  // üîß Delay necess√°rio para o layout carregar completamente
  await new Promise(r => setTimeout(r, 150));

  return { wrapper };
}

// ====== EXPORTAR PNG ======
async function generateImage() {
  const btn = document.getElementById("exportBtn");
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "Gerando...";
  try {
    const { wrapper } = await prepareExportWrapper();
    const canvas = await html2canvas(wrapper, { scale: 2, backgroundColor: "#fff", useCORS: true });
    const img = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    const year = viewDate.getFullYear();
    a.href = img;
    a.download = `cantina-${year}-${String(viewDate.getMonth() + 1).padStart(2, "0")}.png`;
    a.click();
    wrapper.remove();
  } catch (err) {
    console.error("Erro PNG:", err);
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

// ====== EXPORTAR PDF ======
async function generatePDF() {
  const btn = document.getElementById("exportPdfBtn");
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "Gerando...";
  try {
    const { wrapper } = await prepareExportWrapper();
    const canvas = await html2canvas(wrapper, { scale: 2, backgroundColor: "#fff", useCORS: true });
    const img = canvas.toDataURL("image/png");
    const pdf = new window.jspdf.jsPDF("landscape", "mm", "a4");
    const w = pdf.internal.pageSize.getWidth();
    const h = pdf.internal.pageSize.getHeight();
    const ratio = Math.min(w / canvas.width, h / canvas.height);
    const imgW = canvas.width * ratio;
    const imgH = canvas.height * ratio;
    const x = (w - imgW) / 2;
    const y = (h - imgH) / 2;
    pdf.addImage(img, "PNG", x, y, imgW, imgH, undefined, "FAST");
    pdf.save(`cantina-${viewDate.getFullYear()}-${String(viewDate.getMonth() + 1).padStart(2, "0")}.pdf`);
    wrapper.remove();
  } catch (err) {
    console.error("Erro PDF:", err);
  } finally {
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

loadData();
</script>
</body>
</html>
